<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Secretar√≠a</title>
  <link rel="stylesheet" href="styles.css" />

  </head>
<body>
  <header class="site-header">
    <h2 class="site-title">Panel Secretar√≠a</h2>
    <nav class="nav"><a href="login.html">Salir</a></nav>
  </header>

  <main class="container">
    <div class="panel-secretaria">
      <section class="card">
        <h1>üìã Panel de Secretar√≠a</h1>
      </section>

      <section class="card">
        <h2>üë©‚Äçüéì Registrar Alumno</h2>
        <form id="formAlumno">
          <input type="text" id="aNombre" placeholder="Nombre" required />
          <input type="text" id="aApellido" placeholder="Apellido" required />
          <input type="email" id="aEmail" placeholder="Email" required />
          <input type="password" id="aPassword" placeholder="Contrase√±a" required />
          <button type="submit" class="btn btn-primary">Registrar Alumno</button>
        </form>
        <div id="alumnoMsg" class="message"></div>
      </section>

      <section class="card">
        <h2>üë®‚Äçüè´ Registrar Profesor</h2>
        <form id="formProfesor">
          <input type="text" id="pNombre" placeholder="Nombre" required />
          <input type="text" id="pApellido" placeholder="Apellido" required />
          <input type="email" id="pEmail" placeholder="Email" required />
          <input type="password" id="pPassword" placeholder="Contrase√±a" required />
          <button type="submit" class="btn btn-primary">Registrar Profesor</button>
        </form>
        <div id="profesorMsg" class="message"></div>
      </section>

      <section class="card">
        <h2>üìö Registrar Materia</h2>
        <form id="formMateria">
          <input type="text" id="mNombre" placeholder="Nombre de la materia" required />
          <select id="profSelect" required>
            <option value="">-- Seleccione Profesor --</option>
          </select>
          <button type="submit" class="btn btn-primary">Crear Materia</button>
        </form>
        <div id="materiaMsg" class="message"></div>
      </section>

      <section class="card">
        <h2>üë®‚Äçüéì Asignar Alumno a Materia</h2>
        <form id="formAlumnoMateria" class="form-asignar">
          <select id="alumnoSelect" required></select>
          <select id="materiaSelectAlumno" required></select>
          <button type="submit" class="btn btn-primary">Asignar Alumno</button>
        </form>
        <div id="alumnoMateriaMsg" class="message"></div>
      </section>

      <div style="text-align:center; margin:24px 0;">
        <button class="cerrar-sesion" id="logoutBtn">Cerrar sesi√≥n</button>
      </div>
    </div>
  </main>

  <script>
    // --- MEJORAS DE JAVASCRIPT ---

    // 1. Constante para la URL base de la API
    const API_URL = "http://localhost:3000/api";

    // 2. Eficiencia: Obtenemos todos los elementos del DOM una sola vez.
    const dom = {
      // Formularios
      formAlumno: document.getElementById("formAlumno"),
      formProfesor: document.getElementById("formProfesor"),
      formMateria: document.getElementById("formMateria"),
      formAlumnoMateria: document.getElementById("formAlumnoMateria"),
      // Inputs Alumno
      aNombre: document.getElementById("aNombre"),
      aApellido: document.getElementById("aApellido"),
      aEmail: document.getElementById("aEmail"),
      aPassword: document.getElementById("aPassword"),
      // Inputs Profesor
      pNombre: document.getElementById("pNombre"),
      pApellido: document.getElementById("pApellido"),
      pEmail: document.getElementById("pEmail"),
      pPassword: document.getElementById("pPassword"),
      // Inputs Materia
      mNombre: document.getElementById("mNombre"),
      // Selects
      profSelect: document.getElementById("profSelect"),
      alumnoSelect: document.getElementById("alumnoSelect"),
      materiaSelectAlumno: document.getElementById("materiaSelectAlumno"),
      // Mensajes
      alumnoMsg: document.getElementById("alumnoMsg"),
      profesorMsg: document.getElementById("profesorMsg"),
      materiaMsg: document.getElementById("materiaMsg"),
      alumnoMateriaMsg: document.getElementById("alumnoMateriaMsg"),
      // Botones
      logoutBtn: document.getElementById("logoutBtn"),
    };

    /**
     * 3. Mantenibilidad: Funci√≥n gen√©rica para mostrar mensajes.
     */
    function mostrarMensaje(elemento, texto, esError = false) {
      elemento.textContent = `${esError ? "‚ùå" : "‚úÖ"} ${texto}`;
    }

    /**
     * 4. Mantenibilidad (DRY): Funci√≥n gen√©rica para rellenar selects.
     * @param {HTMLSelectElement} selectEl - El elemento <select> a rellenar.
     * @param {string} endpoint - La URL de la API de donde obtener los datos.
     * @param {string} valueProp - El nombre de la propiedad para el 'value' (ej: 'id_alumno').
     * @param {function} textCallback - Funci√≥n que recibe un item y devuelve el texto del 'option'.
     * @param {string} placeholder - Texto para la primera opci√≥n deshabilitada.
     */
    async function popularSelect(selectEl, endpoint, valueProp, textCallback, placeholder) {
      try {
        const res = await fetch(`${API_URL}/${endpoint}`);
        if (!res.ok) throw new Error("No se pudieron cargar los datos");
        
        const data = await res.json();
        selectEl.innerHTML = `<option value="">-- ${placeholder} --</option>`;

        if (!Array.isArray(data) || data.length === 0) {
          selectEl.innerHTML = `<option value="" disabled>No hay datos disponibles</option>`;
          return;
        }

        data.forEach((item) => {
          const opt = document.createElement("option");
          opt.value = item[valueProp];
          opt.textContent = textCallback(item);
          selectEl.appendChild(opt);
        });
      } catch (error) {
        console.error(`Error al popular ${selectEl.id}:`, error);
        selectEl.innerHTML = `<option value="" disabled>Error al cargar</option>`;
      }
    }

    // Funciones de carga refactorizadas para usar el helper 'popularSelect'
    function cargarProfesores() {
      return popularSelect(
        dom.profSelect,
        "profesores",
        "id_profesor",
        (p) => `${p.nombre} ${p.apellido}`,
        "Seleccione Profesor"
      );
    }
    
    function cargarAlumnos() {
      return popularSelect(
        dom.alumnoSelect,
        "alumnos",
        "id_alumno",
        (a) => `${a.nombre} ${a.apellido}`,
        "Seleccione Alumno"
      );
    }
    
    function cargarMaterias() {
      // Esta funci√≥n rellena el select para "Asignar Alumno a Materia"
      return popularSelect(
        dom.materiaSelectAlumno,
        "materias",
        "id_materia",
        (m) => m.nombre,
        "Seleccione Materia"
      );
    }
    
    /**
     * 5. Mantenibilidad (DRY): Funci√≥n gen√©rica para registrar usuarios (alumno/profesor).
     */
    async function registrarUsuario(e, rol) {
      e.preventDefault();
      
      const esAlumno = rol === "alumno";
      const form = esAlumno ? dom.formAlumno : dom.formProfesor;
      const nombre = esAlumno ? dom.aNombre.value : dom.pNombre.value;
      const apellido = esAlumno ? dom.aApellido.value : dom.pApellido.value;
      const email = esAlumno ? dom.aEmail.value : dom.aEmail.value;
      const password = esAlumno ? dom.aPassword.value : dom.pPassword.value;
      const msgEl = esAlumno ? dom.alumnoMsg : dom.profesorMsg;

      const body = {
        username: email.split("@")[0],
        password,
        rol,
        nombre,
        apellido,
        email,
      };

      try {
        const res = await fetch(`${API_URL}/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || data.message || "Error desconocido");
        }
        
        mostrarMensaje(msgEl, `${rol.charAt(0).toUpperCase() + rol.slice(1)} registrado correctamente`);
        form.reset();
        
        // Si registramos un profesor, recargamos la lista de profesores
        if (!esAlumno) {
          await cargarProfesores();
        }
      } catch (error) {
        console.error(`Error al registrar ${rol}:`, error);
        mostrarMensaje(msgEl, error.message, true);
      }
    }

    // --- Vinculaci√≥n de Eventos ---

    // 6. Robustez: Un solo listener para DOMContentLoaded con try...catch
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        // Usamos Promise.all para cargar todo en paralelo
        await Promise.all([
          cargarProfesores(),
          cargarAlumnos(),
          cargarMaterias() // Carga las materias en el select de asignaci√≥n
        ]);
      } catch (error) {
        console.error("Error fatal al cargar datos iniciales:", error);
        // Podr√≠as mostrar un error global al usuario aqu√≠
      }
    });

    // 7. Robustez: Los listeners ahora usan las funciones refactorizadas
    dom.formAlumno.addEventListener("submit", (e) => registrarUsuario(e, "alumno"));
    dom.formProfesor.addEventListener("submit", (e) => registrarUsuario(e, "profesor"));

    // üìö Crear materia
    dom.formMateria.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nombre = dom.mNombre.value.trim();
      const id_profesor = parseInt(dom.profSelect.value);

      if (!nombre || !id_profesor) {
        dom.materiaMsg.textContent = "‚ö†Ô∏è Ingrese nombre y seleccione profesor.";
        return;
      }
      
      try {
        const res = await fetch(`${API_URL}/materias`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nombre, id_profesor }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || data.message);
        
        mostrarMensaje(dom.materiaMsg, "Materia creada correctamente");
        e.target.reset();
        await cargarMaterias(); // Recarga la lista de materias
      } catch (error) {
        console.error("Error al crear materia:", error);
        mostrarMensaje(dom.materiaMsg, error.message, true);
      }
    });

    // ‚úÖ Registrar alumno en materia
    dom.formAlumnoMateria.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id_alumno = parseInt(dom.alumnoSelect.value);
      const id_materia = parseInt(dom.materiaSelectAlumno.value);

      if (!id_alumno || !id_materia) {
        dom.alumnoMateriaMsg.textContent = "‚ö†Ô∏è Seleccione alumno y materia.";
        return;
      }
      
      try {
        const res = await fetch(`${API_URL}/alumnos/asignar`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id_alumno, id_materia }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || data.message);

        mostrarMensaje(dom.alumnoMateriaMsg, "Alumno asignado correctamente");
        e.target.reset(); // Opcional: resetear los selects
      } catch (error) {
        console.error("Error al asignar alumno:", error);
        mostrarMensaje(dom.alumnoMateriaMsg, error.message, true);
      }
    });

    // üö™ Cerrar sesi√≥n
    dom.logoutBtn.addEventListener("click", () => {
      // Opcional: Limpiar localStorage si es necesario
      // localStorage.removeItem("usuario");
      window.location.href = "login.html";
    });
  </script>
</body>
</html>