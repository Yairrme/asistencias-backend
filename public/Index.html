<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Profesor - Sistema de Asistencias</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1 id="welcome-title">Bienvenido, Profesor üë®‚Äçüè´</h1>
  <button id="logout">Cerrar sesi√≥n</button>

  <h2>Listado General de Asistencias</h2>
  <button onclick="cargarAsistencias()">üîÑ Actualizar</button>
  <table id="tabla-asistencias">
    <thead>
      <tr>
        <th>ID</th>
        <th>Alumno</th>
        <th>Materia</th>
        <th>Fecha</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Registrar Nueva Asistencia</h2>
  <form id="form-asistencia">
    <label>Materia y Fecha:
      <select id="clase_id" required></select>
    </label>
    <label>Alumno:
      <select id="alumno_id" required></select>
    </label>
    <label>Estado:
      <select id="estado">
        <option value="Presente">Presente</option>
        <option value="Ausente">Ausente</option>
        <option value="Tarde">Tarde</option>
        <option value="Justificado">Justificado</option> </select>
    </label>
    <button type="submit">Registrar Asistencia</button>
  </form>

  <script>
    const API_URL = "http://localhost:3000";
    const token = sessionStorage.getItem("token");
    const tipoUsuario = sessionStorage.getItem("tipo");
    const nombreUsuario = sessionStorage.getItem("nombre");

    // üîí Verificaci√≥n de seguridad
    if (!token || tipoUsuario !== 'profesor') {
      alert("Acceso denegado. Debes iniciar sesi√≥n como profesor.");
      window.location.href = "login.html";
    }

    // Personalizar bienvenida
    if (nombreUsuario) {
      document.getElementById("welcome-title").textContent = `Bienvenido, Profesor ${nombreUsuario} üë®‚Äçüè´`;
    }

    // Cargar todas las asistencias (vista de profesor)
    async function cargarAsistencias() {
      try {
        const res = await fetch(`${API_URL}/asistencias/all`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        if (res.status === 401) throw new Error("Sesi√≥n expirada");
        
        const data = await res.json();
        const tbody = document.querySelector("#tabla-asistencias tbody");
        tbody.innerHTML = "";
        data.forEach(a => {
          tbody.innerHTML += `
            <tr>
              <td>${a.id || "-"}</td>
              <td>${a.nombre || "-"} ${a.apellido || ""}</td>
              <td>${a.materia}</td>
              <td>${new Date(a.fecha).toLocaleDateString()}</td>
              <td>${a.estado}</td>
            </tr>`;
        });
      } catch (err) {
        console.error("Error cargando asistencias:", err);
        alert("Error al cargar asistencias. Tu sesi√≥n puede haber expirado.");
        window.location.href = "login.html";
      }
    }

    // Cargar alumnos en el dropdown
    async function cargarAlumnos() {
      try {
        const res = await fetch(`${API_URL}/alumnos`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();
        const select = document.querySelector("#alumno_id");
        select.innerHTML = '<option value="">-- Seleccione un alumno --</option>';
        data.forEach(al => {
          select.innerHTML += `<option value="${al.id}">${al.nombre} ${al.apellido || ''}</option>`;
        });
      } catch (err) { console.error("Error cargando alumnos:", err); }
    }

    // Cargar clases en el dropdown
    async function cargarClases() {
      try {
        const res = await fetch(`${API_URL}/clases`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();
        const select = document.querySelector("#clase_id");
        select.innerHTML = '<option value="">-- Seleccione una materia y fecha --</option>';
        data.forEach(cl => {
          select.innerHTML += `<option value="${cl.id}">${cl.materia} - ${new Date(cl.fecha).toLocaleDateString()}</option>`;
        });
      } catch (err) { console.error("Error cargando clases:", err); }
    }

    // Event listener para registrar asistencia
    document.querySelector("#form-asistencia").addEventListener("submit", async (e) => {
      e.preventDefault();
      const alumno_id = document.querySelector("#alumno_id").value;
      const clase_id = document.querySelector("#clase_id").value;
      const estado = document.querySelector("#estado").value;

      if (!alumno_id || !clase_id) {
        alert("Por favor, seleccione alumno y materia.");
        return;
      }

      try {
        const res = await fetch(`${API_URL}/asistencias`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ alumno_id, clase_id, estado })
        });
        const result = await res.json();
        alert(result.message || "Asistencia registrada con √©xito");
        cargarAsistencias(); // Actualizar la tabla
        document.querySelector("#form-asistencia").reset(); // Limpiar formulario
      } catch (err) {
        console.error("Error registrando asistencia:", err);
        alert("Ocurri√≥ un error al registrar la asistencia.");
      }
    });

    // Cerrar sesi√≥n
    document.getElementById("logout").addEventListener("click", () => {
      sessionStorage.clear();
      window.location.href = "login.html";
    });

    // Carga inicial
    window.onload = () => {
      cargarAsistencias();
      cargarAlumnos();
      cargarClases();
    };
  </script>
</body>
</html>