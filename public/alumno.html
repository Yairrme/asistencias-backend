<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel del Alumno</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #f3f3f3;
    }
    .error-btn {
      background-color: #ff9800;
      color: white;
      border: none;
      padding: 5px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .cerrar-sesion {
      background-color: #555;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <h2 class="site-title">Panel Alumno</h2>
    <nav class="nav">
      <a href="login.html">Salir</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h1>Panel del Alumno</h1>
      <p id="info"></p>

      <label for="materiaSelect">Seleccione la materia:</label>
      <select id="materiaSelect">
        <option value="">-- Seleccione materia --</option>
      </select>

      <button id="verStatsBtn" class="cerrar-sesion">Ver estad√≠sticas</button>
<button id="ocultarStatsBtn" class="cerrar-sesion" style="display:none;background:#777;">Ocultar estad√≠sticas</button>

<div id="estadisticasBox" style="
    display:none;
    margin-top:20px;
    padding:15px;
    border:1px solid #ccc;
    border-radius:8px;
    background:#f8f8f8;
">
  <h3>üìä Estad√≠sticas de Asistencia</h3>
  <p><strong>Materia:</strong> <span id="statsMateria"></span></p>
  <p><strong>Total de clases:</strong> <span id="statsTotal"></span></p>
  <p><strong>Presentes:</strong> <span id="statsPresentes"></span></p>
  <p><strong>Ausentes:</strong> <span id="statsAusentes"></span></p>
  <p><strong>Porcentaje de asistencia:</strong> <span id="statsPorcentaje"></span></p>
</div>


      <div style="overflow:auto; margin-top:14px;">
        <table id="tablaAsistencias" class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Materia</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p id="mensaje" class="message"></p>
      <div style="text-align:center; margin-top:12px;">
        <button class="cerrar-sesion" id="logoutBtn">Cerrar sesi√≥n</button>
      </div>
    </section>
  </main>

  <script>
    const usuario = JSON.parse(localStorage.getItem("usuario"));
    const info = document.getElementById("info");
    const tabla = document.querySelector("#tablaAsistencias tbody");
    const mensaje = document.getElementById("mensaje");
    const materiaSelect = document.getElementById("materiaSelect");

    if (!usuario || usuario.rol !== "alumno") {
      alert("Acceso no autorizado. Inicia sesi√≥n como alumno.");
      window.location.href = "login.html";
    } else {
      info.textContent = `üë®‚Äçüéì Bienvenido, ${usuario.nombre} ${usuario.apellido}`;
      cargarMaterias(usuario.id_alumno || usuario.id);
    }

    async function cargarMaterias(alumnoId) {
      try {
        const res = await fetch(`http://localhost:3000/api/materias/por-alumno/${alumnoId}`);
        const materias = await res.json();

        if (materias.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Sin materias asignadas";
          materiaSelect.appendChild(opt);
          return;
        }

        materias.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.id_materia;
          opt.textContent = m.nombre;
          materiaSelect.appendChild(opt);
        });
      } catch (error) {
        console.error("Error al cargar materias:", error);
        mensaje.textContent = "‚ö†Ô∏è Error al obtener las materias.";
      }
    }

    materiaSelect.addEventListener("change", async () => {
      const materiaId = materiaSelect.value;
      if (!materiaId) {
        tabla.innerHTML = "";
        return;
      }
      cargarAsistencias(materiaId);
    });

async function cargarAsistencias(materiaId) {
  try {
    // pedir todas las asistencias del alumno
    const res = await fetch(`http://localhost:3000/api/asistencias/por-alumno/${usuario.id_alumno || usuario.id}`);
    if (!res.ok) throw new Error(`Error ${res.status}`);
    const asistencias = await res.json();

    tabla.innerHTML = "";

    if (!asistencias || asistencias.length === 0) {
      tabla.innerHTML = `<tr><td colspan="5">No hay asistencias registradas a√∫n.</td></tr>`;
      return;
    }

    // Normalizamos el id de materia seleccionado (string -> number)
    const materiaIdNum = Number(materiaId);

    // Detectar qu√© campo trae el backend para el id de materia:
    // posibles nombres: 'materia_id', 'id_materia', 'materiaId', 'materia'
    // y tambi√©n el nombre para mostrar la materia: 'materia' o 'nombre'
    const posibleCamposId = ['materia_id', 'id_materia', 'materiaId', 'materia_id', 'materiaID'];
    const posibleCamposNombre = ['materia', 'nombre'];

    // Encuentra el campo id que exista en el primer registro (si existe)
    let campoId = null;
    if (asistencias.length > 0) {
      const ejemplo = asistencias[0];
      for (const c of posibleCamposId) {
        if (Object.prototype.hasOwnProperty.call(ejemplo, c)) {
          campoId = c;
          break;
        }
      }
    }

    // Si no encontr√≥ campoId, vamos a intentar buscar por 'materia' (nombre) comparando strings.
    const filtradas = asistencias.filter(a => {
      if (campoId) {
        // compara num√©ricamente si posible
        return Number(a[campoId]) === materiaIdNum;
      }
      // fallback: si no hay campo id, intentar comparar el nombre de la materia si hay campo 'materia' o 'nombre'
      for (const n of posibleCamposNombre) {
        if (a[n]) {
          // compara insensitivo (may√∫sc/min√∫sc) con el texto del option
          const optTexto = (materiaSelect.options[materiaSelect.selectedIndex]?.text || "").trim().toLowerCase();
          if (String(a[n]).trim().toLowerCase() === optTexto) return true;
        }
      }
      return false;
    });

    if (filtradas.length === 0) {
      tabla.innerHTML = `<tr><td colspan="5">No hay asistencias para esta materia.</td></tr>`;
      console.debug('Asistencias completas recibidas:', asistencias);
      return;
    }

    // Renderizar filas filtradas
    filtradas.forEach(asistencia => {
      // Intentamos extraer fecha si existe en distintos nombres
      const fechaRaw = asistencia.fecha || asistencia.fecha_asistencia || asistencia.created_at || asistencia.date || null;
      const fechaFormateada = fechaRaw ? new Date(fechaRaw).toLocaleDateString("es-AR") : "‚Äî";

      // nombre de materia para mostrar
      let nombreMateria = asistencia.materia || asistencia.nombre || asistencia.materia_nombre || "";
      if (!nombreMateria && campoId) {
        // si no hay nombre, podemos dejar el texto del select
        nombreMateria = materiaSelect.options[materiaSelect.selectedIndex]?.text || "";
      }

      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${asistencia.id ?? asistencia.id_asistencia ?? ""}</td>
        <td>${nombreMateria}</td>
        <td>${fechaFormateada}</td>
        <td>${(asistencia.estado ?? asistencia.presente ?? asistencia.presencia) ? "Presente" : "Ausente"}</td>
        <td><button class="error-btn" onclick="marcarError(${asistencia.id ?? asistencia.id_asistencia})">Reportar error</button></td>
      `;
      tabla.appendChild(fila);
    });

  } catch (error) {
    console.error("Error al cargar asistencias:", error);
    mensaje.textContent = "‚ö†Ô∏è Error al obtener tus asistencias.";
  }
}
    async function marcarError(id) {
      try {
        const confirmacion = confirm("¬øDeseas reportar un error en esta asistencia?");
        if (!confirmacion) return;

        const res = await fetch(`http://localhost:3000/api/asistencias/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ estado: 'Presente' })
        });

        if (res.ok) {
          mensaje.textContent = "‚úÖ Asistencia actualizada.";
          const materiaId = materiaSelect.value;
          if (materiaId) cargarAsistencias(materiaId);
        } else {
          mensaje.textContent = "‚ùå No se pudo actualizar la asistencia.";
        }
      } catch (error) {
        console.error(error);
        mensaje.textContent = "‚ö†Ô∏è Error al conectar con el servidor.";
      }
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("usuario");
      window.location.href = "login.html";
    });

  document.getElementById("verStatsBtn").addEventListener("click", cargarEstadisticasAlumno);
document.getElementById("ocultarStatsBtn").addEventListener("click", () => {
  document.getElementById("estadisticasBox").style.display = "none";
  document.getElementById("ocultarStatsBtn").style.display = "none";
  document.getElementById("verStatsBtn").style.display = "inline-block";
});

async function cargarEstadisticasAlumno() {
  const materiaId = materiaSelect.value;

  if (!materiaId) {
    alert("Selecciona una materia primero.");
    return;
  }

  try {
    const res = await fetch(`http://localhost:3000/api/asistencias/por-alumno/${usuario.id_alumno || usuario.id}`);
    const asistencias = await res.json();

    if (!Array.isArray(asistencias)) {
      alert("Error al obtener estad√≠sticas.");
      return;
    }

    // Filtrar por materia (apto para cualquier backend)
    const asistFiltradas = asistencias.filter(a => 
      Number(a.id_materia || a.materia_id) === Number(materiaId)
    );

    if (asistFiltradas.length === 0) {
      alert("No hay asistencias registradas para esta materia.");
      return;
    }

    // Calcular datos
    const totalClases = asistFiltradas.length;
    const presentes = asistFiltradas.filter(a => a.presente == 1 || a.estado == 1).length;
    const ausentes = totalClases - presentes;
    const porcentaje = ((presentes / totalClases) * 100).toFixed(1);

    // Mostrar
    document.getElementById("statsMateria").textContent =
      materiaSelect.options[materiaSelect.selectedIndex].text;

    document.getElementById("statsTotal").textContent = totalClases;
    document.getElementById("statsPresentes").textContent = presentes;
    document.getElementById("statsAusentes").textContent = ausentes;
    document.getElementById("statsPorcentaje").textContent = porcentaje + "%";

    // Mostrar cuadro
    document.getElementById("estadisticasBox").style.display = "block";
    document.getElementById("ocultarStatsBtn").style.display = "inline-block";
    document.getElementById("verStatsBtn").style.display = "none";
  } catch (error) {
    console.error("Error al cargar estad√≠sticas:", error);
    alert("Hubo un error cargando estad√≠sticas.");
  }
}

  </script>
</body>
</html>
