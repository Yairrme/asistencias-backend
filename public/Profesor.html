<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel del Profesor</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #f3f3f3;
    }
    button {
      padding: 6px 10px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .presente { background-color: #4caf50; color: white; }
    .ausente { background-color: #f44336; color: white; }
    .btn-disabled { opacity: 0.6; pointer-events: none; }
    .selected-presente { box-shadow: 0 0 0 3px rgba(76,175,80,0.18); }
    .selected-ausente { box-shadow: 0 0 0 3px rgba(244,67,54,0.18); }
    select {
      padding: 8px;
      margin-top: 10px;
      border-radius: 6px;
    }
    .cerrar-sesion {
      background-color: #555;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <h2 class="site-title">Panel Profesor</h2>
    <nav class="nav">
      <a href="login.html">Salir</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h1>Panel del Profesor</h1>
      <p id="info"></p>
      <p><strong>üìÖ Fecha actual:</strong> <span id="fechaActual"></span></p>

      <label for="materiaSelect">Seleccione la materia:</label>
      <select id="materiaSelect">
         <option value="">-- Seleccione materia --</option>
      </select>

      <section id="historial-section" style="margin-top: 20px;">
        <button id="toggleHistorialBtn">üìú Ver historial</button>

        <div id="historial-container" style="display:none; margin-top:10px;">
          <div id="fechas-container"></div>
          <div id="detalle-historial" style="margin-top:15px;"></div>
        </div>
      </section>

      <button id="btn-toggle-estadisticas" style="margin-top:16px;">üìä Ver estad√≠sticas</button>

      <div id="contenedor-estadisticas" style="display:none; margin-top:15px;">
        <div id="info-estadisticas"></div>

        <table id="tabla-estadisticas" border="1" cellspacing="0" cellpadding="4" style="width:100%; text-align:center;">
          <thead>
            <tr>
              <th>Alumno</th>
              <th>Presentes</th>
              <th>Ausentes</th>
              <th>Total</th>
              <th>% Asistencia</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      <div style="margin-top: 15px;">
        <button id="btnExcel">üìä Exportar a Excel</button>
        <button id="btnPDF">üìÑ Exportar a PDF</button>
      </div>
      </div>

      <div style="overflow:auto; margin-top:14px;">
        <table id="tablaAlumnos" class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p id="mensaje" class="message"></p>
      <div style="text-align:center; margin-top:12px;">
        <button class="cerrar-sesion" id="logoutBtn">Cerrar sesi√≥n</button>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <script>
    const usuario = JSON.parse(localStorage.getItem("usuario"));
    const info = document.getElementById("info");
    const tabla = document.querySelector("#tablaAlumnos tbody");
    const mensaje = document.getElementById("mensaje");
    const materiaSelect = document.getElementById("materiaSelect");

    // Mostrar la fecha actual
    const fechaActualEl = document.getElementById("fechaActual");
    const hoy = new Date();
    const opciones = { day: "2-digit", month: "2-digit", year: "numeric" };
    fechaActualEl.textContent = hoy.toLocaleDateString("es-AR", opciones);

    if (!usuario || usuario.rol !== "profesor") {
      alert("Acceso no autorizado. Inicia sesi√≥n como profesor.");
      window.location.href = "login.html";
    } else {
      info.textContent = `üë®‚Äçüè´ Bienvenido, Prof. ${usuario.nombre} ${usuario.apellido}`;
      cargarMateriasProfesor(usuario.id_profesor || usuario.id);
    }

    async function cargarMateriasProfesor(profesorId) {
      try {
        const res = await fetch(`http://localhost:3000/api/materias/por-profesor/${profesorId}`);
        const materias = await res.json();

        materiaSelect.innerHTML = '<option value="">-- Seleccionar --</option>';

        if (!materias || materias.length === 0) {
          const opt = document.createElement("option");
          opt.textContent = "Sin materias asignadas";
          materiaSelect.appendChild(opt);
          return;
        }

        materias.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.id_materia;
          opt.textContent = m.nombre;
          materiaSelect.appendChild(opt);
        });
      } catch (error) {
        console.error("Error al cargar materias:", error);
        mensaje.textContent = "‚ö†Ô∏è Error al cargar materias.";
      }
    }

    materiaSelect.addEventListener("change", async () => {
      const materiaId = materiaSelect.value;
      if (materiaId) {
        cargarAlumnos(materiaId);
        // opcional: actualizar estad√≠sticas autom√°ticamente al cambiar materia
        // cargarEstadisticas(materiaId);
      } else {
        tabla.innerHTML = "";
      }
    });

    async function cargarAlumnos(materiaId) {
      try {
        const res = await fetch(`http://localhost:3000/api/alumnos/por-materia/${materiaId}`);
        const alumnos = await res.json();
        tabla.innerHTML = "";

        alumnos.forEach(alumno => {
          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td>${alumno.id_alumno}</td>
            <td>${alumno.nombre}</td>
            <td>${alumno.apellido}</td>
            <td>
              <button class="presente" data-alumno="${alumno.id_alumno}" data-estado="Presente" onclick="registrarAsistencia(${alumno.id_alumno}, 'Presente', ${materiaId})">Presente</button>
              <button class="ausente" data-alumno="${alumno.id_alumno}" data-estado="Ausente" onclick="registrarAsistencia(${alumno.id_alumno}, 'Ausente', ${materiaId})">Ausente</button>
            </td>
          `;
          tabla.appendChild(fila);
        });

        // Despu√©s de renderizar alumnos, obtener asistencias registradas hoy para esta materia
        try {
          const today = new Date().toISOString().slice(0,10);
          // usamos la ruta por-materia y filtramos por fecha localmente
          const r = await fetch(`http://localhost:3000/api/asistencias/por-materia/${materiaId}`);
          if (r.ok) {
            const historial = await r.json();
            // historial es array agrupado por fecha: [{fecha, alumnos: [...]}, ...]
            const hoyEntry = historial.find(d => {
              // d.fecha puede venir en formato 'YYYY-MM-DD' o Date-string
              return String(d.fecha).startsWith(today);
            });
            if (hoyEntry && Array.isArray(hoyEntry.alumnos)) {
              hoyEntry.alumnos.forEach(a => {
                // aqu√≠ a no tiene id, solo nombre/apellido/presente en tu agrupado original
                // para poder deshabilitar por id necesitamos comparar por nombre+apellido o modificar backend para devolver id
                // intentamos deshabilitar por coincidencia de apellido+nombre en la tabla
                const alumnoNombre = `${a.nombre}`.trim();
                const alumnoApellido = `${a.apellido}`.trim();
                // buscar fila en DOM
                const botones = Array.from(document.querySelectorAll('button[data-alumno]'));
                botones.forEach(btn => {
                  const filaTr = btn.closest('tr');
                  const tdNombre = filaTr.querySelector('td:nth-child(2)').textContent.trim();
                  const tdApellido = filaTr.querySelector('td:nth-child(3)').textContent.trim();
                  if (tdNombre === alumnoNombre && tdApellido === alumnoApellido) {
                    // deshabilitar todos los botones de este alumno
                    const allBtns = filaTr.querySelectorAll('button');
                    allBtns.forEach(b => b.classList.add('btn-disabled'));
                    const estado = Number(a.presente) === 1 ? 'Presente' : 'Ausente';
                    const selector = `button[data-alumno="${filaTr.querySelector('td').textContent.trim()}"][data-estado="${estado}"]`;
                    // intentar marcar visualmente por data-estado (si coincide)
                    const elegido = Array.from(filaTr.querySelectorAll('button')).find(b => b.dataset.estado === estado);
                    if (elegido) {
                      if (estado === 'Presente') elegido.classList.add('selected-presente');
                      else elegido.classList.add('selected-ausente');
                    }
                  }
                });
              });
            }
          }
        } catch (err) {
          console.error('No se pudo obtener asistencias registradas:', err);
        }
      } catch (error) {
        mensaje.textContent = "‚ö†Ô∏è Error al cargar alumnos.";
        console.error(error);
      }
    }

    async function registrarAsistencia(id_alumno, estado, materiaId) {
      try {
        if (!materiaId) {
          alert('Seleccione una materia antes de registrar la asistencia.');
          return;
        }

        const presente = estado === 'Presente' ? 1 : 0;

        // <-- clave corregida: enviar id_alumno (no alumno_id)
        const res = await fetch('http://localhost:3000/api/asistencias', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id_alumno: id_alumno, id_materia: Number(materiaId), presente }),
        });

        if (res.ok) {
          mensaje.textContent = '‚úÖ Asistencia registrada correctamente.';

          // Deshabilitar los botones para este alumno y marcar la elecci√≥n
          const botones = document.querySelectorAll(`button[data-alumno="${id_alumno}"]`);
          botones.forEach(b => b.classList.add('btn-disabled'));

          // Marcar el bot√≥n seleccionado visualmente
          const selector = `button[data-alumno="${id_alumno}"][data-estado="${estado}"]`;
          const elegido = document.querySelector(selector);
          if (elegido) {
            if (estado === 'Presente') elegido.classList.add('selected-presente');
            else elegido.classList.add('selected-ausente');
          }
        } else {
          const data = await res.json().catch(()=>null);
          mensaje.textContent = '‚ùå Error al registrar asistencia.' + (data && data.error ? ' ' + data.error : '');
        }
      } catch (error) {
        console.error(error);
        mensaje.textContent = '‚ö†Ô∏è Error al conectar con el servidor.';
      }
    }

    // üìú --- HISTORIAL DE ASISTENCIAS ---
    const toggleHistorialBtn = document.getElementById("toggleHistorialBtn");
    const historialContainer = document.getElementById("historial-container");
    const fechasContainer = document.getElementById("fechas-container");
    const detalleHistorial = document.getElementById("detalle-historial");

    // Mostrar/ocultar historial
    toggleHistorialBtn.addEventListener("click", async () => {
      const materiaId = materiaSelect.value;
      if (!materiaId) {
        alert("Seleccione una materia primero.");
        return;
      }

      if (historialContainer.style.display === "none" || historialContainer.style.display === "") {
        historialContainer.style.display = "block";
        toggleHistorialBtn.textContent = "‚ùå Ocultar historial";
        await cargarFechasHistorial(materiaId);
      } else {
        historialContainer.style.display = "none";
        toggleHistorialBtn.textContent = "üìú Ver historial";
        fechasContainer.innerHTML = "";
        detalleHistorial.innerHTML = "";
      }
    });

    // Cargar fechas del historial de una materia
    async function cargarFechasHistorial(materiaId) {
      fechasContainer.innerHTML = "‚è≥ Cargando fechas...";
      detalleHistorial.innerHTML = "";

      try {
        const res = await fetch(`http://localhost:3000/api/asistencias/por-materia/${materiaId}`);
        if (!res.ok) throw new Error("Error al obtener historial");
        const data = await res.json();

        if (data.length === 0) {
          fechasContainer.innerHTML = "<p>No hay asistencias registradas.</p>";
          return;
        }

        // Mostrar solo las fechas como botones
        fechasContainer.innerHTML = "<h3>üìÖ Fechas disponibles:</h3>";
        data.forEach(item => {
          const btn = document.createElement("button");
          btn.textContent = item.fecha;
          btn.style.margin = "5px";
          btn.addEventListener("click", () => mostrarDetalleFecha(item));
          fechasContainer.appendChild(btn);
        });
      } catch (err) {
        console.error(err);
        fechasContainer.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Error al cargar fechas</p>";
      }
    }

    // Mostrar detalle por fecha
    function mostrarDetalleFecha(item) {
      detalleHistorial.innerHTML = `
        <h3>üóìÔ∏è Asistencias del ${item.fecha}</h3>
        <table border="1" cellspacing="0" cellpadding="5" style="width:100%; margin-top:10px;">
          <tr><th>Alumno</th><th>Estado</th></tr>
          ${item.alumnos.map(a => `
            <tr>
              <td>${a.apellido}, ${a.nombre}</td>
              <td style="color:${a.presente ? 'green' : 'red'};">
                ${a.presente ? 'Presente' : 'Ausente'}
              </td>
            </tr>
          `).join('')}
        </table>
      `;
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("usuario");
      window.location.href = "login.html";
    });

    // ---------- Estad√≠sticas (mostrar/ocultar + cargar) ----------
    const btnToggle = document.getElementById("btn-toggle-estadisticas");
    const contenedorEst = document.getElementById("contenedor-estadisticas");

    btnToggle.addEventListener("click", () => {
      const materiaId = materiaSelect.value;

      if (!materiaId) {
        alert("Seleccione una materia primero.");
        return;
      }

      if (contenedorEst.style.display === "none" || contenedorEst.style.display === "") {
        contenedorEst.style.display = "block";
        btnToggle.textContent = "üîΩ Ocultar estad√≠sticas";
        cargarEstadisticas(materiaId);
      } else {
        contenedorEst.style.display = "none";
        btnToggle.textContent = "üìä Ver estad√≠sticas";
      }
    });

    async function cargarEstadisticas(materiaId) {
      const info = document.getElementById("info-estadisticas");
      const tabla = document.querySelector("#tabla-estadisticas tbody");

      info.innerHTML = "Cargando...";
      tabla.innerHTML = "";

      try {
        const res = await fetch(`http://localhost:3000/api/asistencias/estadisticas/${materiaId}`);
        if (!res.ok) throw new Error("No se pudieron obtener estad√≠sticas");
        const data = await res.json();

        if (!data || typeof data.total_clases === 'undefined') {
          info.innerHTML = "<p>No hay estad√≠sticas disponibles.</p>";
          return;
        }

        info.innerHTML = `
            <h3>üìä Estad√≠sticas generales</h3>
            <p><strong>Total de clases:</strong> ${data.total_clases}</p>
        `;

        tabla.innerHTML = "";
        data.alumnos.forEach(a => {
          tabla.innerHTML += `
              <tr>
                  <td>${a.apellido}, ${a.nombre}</td>
                  <td>${a.presentes}</td>
                  <td>${a.ausentes}</td>
                  <td>${a.total_clases}</td>
                  <td>${a.porcentaje}%</td>
              </tr>
          `;
        });
      } catch (err) {
        console.error(err);
        info.innerHTML = "<p style='color:red;'>Error al cargar estad√≠sticas.</p>";
      }
    }

    // Excel
    document.getElementById("btnExcel").addEventListener("click", () => {
      const tabla = document.querySelector("#tabla-estadisticas");
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(tabla);
      const fecha = new Date().toLocaleString("es-AR");
      // Agregar fecha a la hoja Excel (al final)
      XLSX.utils.sheet_add_aoa(ws, [["Generado:", fecha]], { origin: -1 });
      XLSX.utils.book_append_sheet(wb, ws, "Estadisticas");
      XLSX.writeFile(wb, "estadisticas_asistencia.xlsx");
    });

    // PDF
    document.getElementById("btnPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const fecha = new Date().toLocaleString("es-AR");
      doc.setFontSize(18);
      doc.text("Estad√≠sticas de Asistencia", 14, 18);
      doc.setFontSize(11);
      doc.text(`Generado: ${fecha}`, 14, 26);
      doc.autoTable({
        html: "#tabla-estadisticas",
        startY: 35,
        theme: "grid",
        styles: { halign: "center", valign: "middle" }
      });
      doc.save("estadisticas_asistencia.pdf");
    });

  </script>
</body>
</html>
